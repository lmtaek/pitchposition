<!DOCTYPE html>
<html lang="en-US">

<meta charset="UTF-8">
<meta name="description" content="A web-based game for making music with movement.">
<meta name="keywords" content="Pitch, Position, movement, music">
<meta name="author" content="Lauren Taekman">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
    <meta charset="utf-8">
    <title>Pitch Position</title>
    <h1 align="center" style="font-size:3vw">Pitch Position</h1>
    <p align="center" style="font-size:1.5vw">Remember to allow Pitch Position access to your webcam!</p>
    <style>
      /*
        #container {
            margin: 0px auto;
            width: 500px;
            height: 375px;
            border: 10px #333 solid
        }*/
        #videoElement {
          display: block;
          margin-left: auto;
          margin-right: auto;
            width: 500px;
            height: 375px;
            background-color: #666;
            -webkit-transform: scaleX(-1);
            transform: scaleX(-1);
        }
        #myCanvas {
          margin: 0px auto;
          width: 500px;
          height: 375px;
          background-color: #ff0000;
        }
    </style>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- Load Posenet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
</head>

<body>
    <div id="container">
        <video autoplay="true" id="videoElement" style="max-width:100%; height:auto;"></video>
    </div>
    <div id="controller">
      <button id="snap">Capture image</button>
      <canvas id="myCanvas"></canvas>
    </div>
    <script type="text/javascript" src="cameraAccessReminder.js"> speak(); </script>
    <script type="text/javascript">
      const video = document.getElementById("videoElement");
      const canvas = document.getElementById("myCanvas");
      const snap = document.getElementById("snap");
      var rightArmPos;
      var leftArmPos;
      var headPos;
      var rightHandPos;
      var leftHandPos;


      async function init() {
        if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({video: true}).then(function (stream) {
          window.stream = stream;
          video.srcObject = stream;
          video.addEventListener("play", function() { 
            timerCallback();}, false);
          })
        .catch(function (err0r) {
          alert("Something went wrong with the Camera feed.\nRefresh the page and make sure Pitch Perfect has access to your webcam.");
        });
      }
    }

function timerCallback () {  
    if (video.paused || video.ended) {  
      return;  
    }  
    captureImage();
    calculatePose();  
    setTimeout(function () {  
      timerCallback();  
    }, 64); // roughly 60 frames per second  
  }
    
    
    /*
      function captureImage(videoFeed) {
        if ((videoFeed != null) && (canvas.getContext)) {
          var context = canvas.getContext('2d');
          context.drawImage(videoFeed, 0, 0, video.width, video.height);
          return context;
        } else { 
          alert("Oops! Something went wrong with the Camera feed.\nRefresh the page and try again.");
      }
      } */

      function captureImage() {
        //console.log("this function gets called");
        var context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
      }


      
      //var context = canvas.getContext('2d');
      snap.addEventListener("click", function() {
        var context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        calculatePose();
      })
    
      function calculatePose() {
        posenet.load().then(function(net) {
        const pose = net.estimateSinglePose(canvas, {
          flipHorizontal: true
          });
        return pose;
      }).then(function(pose){
        console.log(pose);
        console.log(pose.keypoints[2].position) 
        rightArmPos = pose.keypoints[8];
        leftArmPos = pose.keypoints[7];
        headPos = pose.keypoints[0];
        rightHandPos = pose.keypoints[10];
        leftHandPos = pose.keypoints[9];
        })
      }

      //processor.doLoad();
      init();
        
    </script>
</body>
</html>